---
import Layout from "@layouts/LayoutStory.astro";
import { turso } from "@src/turso";
import { type Story } from "@types";
export const prerender = false;

const { slug } = Astro.params;
if (!slug) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const storyResponse = await turso.execute({
  sql: "SELECT * FROM stories WHERE slug = ?;",
  args: [slug as string],
});

if (!storyResponse.rows.length) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}
const storyData = storyResponse.rows[0] as any;
if (!storyData) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const story = {
  id: storyData.id,
  slug: storyData.slug,
  text: storyData.text,
  options: JSON.parse(storyData.options),
  title: storyData.title,
  description: storyData.description,
} as Story;
---

<Layout title={story.title} description={story.description} slug={story.slug} resume={story.resume} options={story.options} optionSlug={story.slug} >
  <div set:html={story.text} />
</Layout>
